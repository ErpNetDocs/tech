name: Generate/Update DocFX TOC

on:
  workflow_dispatch:
    inputs:
      target_path:
        description: "–ü–∞–ø–∫–∞—Ç–∞, –∑–∞ –∫–æ—è—Ç–æ –¥–∞ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ TOC (–ø—Ä–∏–º–µ—Ä: docs/operators)"
        required: true
        default: "docs"
      auto_create_subdirs:
        description: "–°—ä–∑–¥–∞–π –ø—Ä–∞–∑–Ω–∏ index.md –∏ toc.yml –≤ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏—Ç–µ (1 –Ω–∏–≤–æ)"
        required: true
        type: boolean
        default: true
      update_parent:
        description: "–™–ø–¥–µ–π—Ç–Ω–∏ —Ä–æ–¥–∏—Ç–µ–ª—Å–∫–∏—è toc.yml —Å –Ω–æ–≤–∞—Ç–∞ —Å–µ–∫—Ü–∏—è"
        required: true
        type: boolean
        default: true
      include_root_files:
        description: "–í–∫–ª—é—á–∏ –∏ –¥—Ä—É–≥–∏ .md —Ñ–∞–π–ª–æ–≤–µ –≤ —Ç–µ–∫—É—â–∞—Ç–∞ –ø–∞–ø–∫–∞ (–æ—Å–≤–µ–Ω index/readme)"
        required: true
        type: boolean
        default: false
      require_sub_index:
        description: "–í–∫–ª—é—á–≤–∞–π –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤ TOC —Å–∞–º–æ –∞–∫–æ –∏–º–∞ index.md/readme.md"
        required: true
        type: boolean
        default: false
      require_sub_toc:
        description: "–í–∫–ª—é—á–≤–∞–π –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤ TOC —Å–∞–º–æ –∞–∫–æ –∏–º–∞ —Å–æ–±—Å—Ç–≤–µ–Ω toc.yml"
        required: true
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  gen-toc:
    name: Generate TOC for "${{ inputs.target_path }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      # üëâ –∞–∫–æ —Å–∫—Ä–∏–ø—Ç—ä—Ç —Ç–∏ –µ –≤ –¥—Ä—É–≥–∞ –ø–∞–ø–∫–∞, —Å–º–µ–Ω–∏ –ø—ä—Ç—è —Ç—É–∫
      - name: Run gen_docfx_root_toc_v4.py
        env:
          TARGET_PATH: ${{ inputs.target_path }}
        run: |
          set -e
          PY_SCRIPT="gen_docfx_root_toc_v4.py"
          if [ ! -f "$PY_SCRIPT" ]; then
            echo "::error file=$PY_SCRIPT::–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω $PY_SCRIPT –≤ –∫–æ—Ä–µ–Ω–∞ –Ω–∞ —Ä–µ–ø–æ—Ç–æ."
            exit 1
          fi

          ARGS="--root \"$TARGET_PATH\" --write"
          ${{ inputs.auto_create_subdirs && 'ARGS="$ARGS --auto-create-subdirs"' || 'true' }}
          ${{ inputs.update_parent && 'ARGS="$ARGS --update-parent"' || 'true' }}
          ${{ inputs.include_root_files && 'ARGS="$ARGS --include-root-files"' || 'true' }}
          ${{ inputs.require_sub_index && 'ARGS="$ARGS --require-sub-index"' || 'true' }}
          ${{ inputs.require_sub_toc && 'ARGS="$ARGS --require-sub-toc"' || 'true' }}

          echo "Running: python $PY_SCRIPT $ARGS"
          eval python "$PY_SCRIPT" $ARGS

      - name: Commit changes (if any)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "toc-bot"
            git config user.email "toc-bot@users.noreply.github.com"
            git add -A
            git commit -m "chore(docs): auto-generate toc.yml for ${{ inputs.target_path }}"
            git push
          else
            echo "No changes to commit."
          fi
