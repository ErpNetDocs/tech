name: Generate DocFX TOC

on:
  workflow_dispatch:
    inputs:
      target_path:
        description: "–ü–∞–ø–∫–∞—Ç–∞, –∑–∞ –∫–æ—è—Ç–æ –¥–∞ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ TOC (–ø—Ä–∏–º–µ—Ä: docs/operators)"
        required: true
        default: "docs"

permissions:
  contents: write

jobs:
  generate-toc:
    name: Generate TOC for "${{ inputs.target_path }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run DocFX TOC generator
        env:
          TARGET_PATH: ${{ inputs.target_path }}
        run: |
          set -e
          PY_SCRIPT="gen_docfx_root_toc_v4.py"

          if [ ! -f "$PY_SCRIPT" ]; then
            echo "::error::–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω $PY_SCRIPT –≤ –∫–æ—Ä–µ–Ω–∞ –Ω–∞ —Ä–µ–ø–æ—Ç–æ."
            exit 1
          fi

          echo "üöÄ –ì–µ–Ω–µ—Ä–∏—Ä–∞–º TOC –∑–∞: $TARGET_PATH"
          python "$PY_SCRIPT" --root "$TARGET_PATH" --write --auto-create-subdirs --update-parent --require-sub-index --verbose

      - name: Commit and push changes (if any)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "toc-bot"
            git config user.email "toc-bot@users.noreply.github.com"
            git add -A
            git commit -m "chore(docs): auto-generate toc.yml for ${{ inputs.target_path }}"
            git push
          else
            echo "‚úÖ –ù—è–º–∞ –ø—Ä–æ–º–µ–Ω–∏ –∑–∞ commit."
          fi
