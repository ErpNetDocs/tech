# Calculating Cost For Produced Products

In the production process, some materials (issued from one or multiple stores) are transformed into a certain output (entered into the store). The cost of the <b>issue</b> transactions has to be transferred to the <b>receipt</b> transactions. This is similar to the transfer and return of goods (see <b>Calculating Cost For Transferred Products</b> and <b>Calculating Cost For Returned Products</b>). However, the calculations are different.

During production, the receipt Store Orders are generated by Output Orders. There are two stages for calculating the cost in the receipt Store Orders:

1. Comparison between the rows in the Consumption Orders and the rows in the Output Orders. For each row in the Output Orders, that comparison defines which materials are used for the production of the product in the current row.

2. For each row in the Consumption Orders, the cost of the issue transactions of the current row is distributed by its relevant Output Orders rows from stage 1.

In the end, it is provided that on each Output Order row, the distributed amount comes only from the materials that are used for the produced products in the current row. This distributed amount is written as a <i>specifically</i> set cost in the <b>receipt</b> Store Order, which is generated by the Output Order.

## Stage 1: Comparison Of The Rows In The Consumption And Output Orders

Released, non-voided Consumption Orders and Output Orders that are sub-documents of a given Work Order are taken into account. For each row of an Output Order, the following is defined: 

what part of the materials is used to produce the specified row and from which Consumption Order rows the materials are taken. 

This data is saved in a <i>Distributed Material Consumptions</i> table (part of the Output Order data).

The Output Orders may get materials only from Consumption Orders released before the Output Order. In other words, the release order for Consumption and Output Orders defines how the quantities in their rows will be compared. When a user creates a new Output Order and releases it, the distributed materials are recalculated. This is true for corrections as well. 

For each Output Order row, the following is executed:

1. All rows for released, non-voided Consumption Orders for the current Work Order Item are <b>filtered</b> (their quantities need to be taken into account). The Consumption Orders are <b>released before</b> the current Output Order.

2. From the quantities of the rows in step 1, quantities of materials distributed on the same Work Order Item by Output Orders (released before the current one) are <b>removed</b>.

3. From what's left of the materials, the necessary quantities for the current row of the Output Order are <b>distributed</b>. They are defined by the <i>Recipe</i> from the Work Order. For the current row, they cannot be distributed in bigger quantities than they are allowed to. Exception is made only for the last Output Orders from each Work Order Item or for the Output Order rows marked as <i>Finished</i>. The rest of the materials are distributed on <i>Finished</i> rows.

When releasing new Consumption Orders or voiding released Consumption Orders, these steps are executed again for each Output Order from the current Work Order. This keeps the distributions for these Output Orders up-to-date.

<b><i>Example 1</b></i>:

There is Work Order producing 3 PCS of a product. The materials are 9 PCS from Material #1 and 12 PCS of Material #2. The materials are consumed in two stages - Consumption Order CO#1, which has 8 PCS from Material #1 and 8 PCS from Material #2, and CO#2, which has 1 PCS from Material #1 and 4 PCS from Material #2. Both Consumption Orders are released and the first Output Order is created for 2 PCS of the Work Order Item. When it is released, the following materials distribution is calculated:

Product, CO#1, Material #1, 6 PCS;
Product, CO#1, Material #2, 8 PCS.
Then the user creates and releases Output Order for the rest 1 PCS  of the Work Order Item. It distributes the following:

Product, CO#1, Material #1, 2 PCS.
Product, CO#2, Material #1, 1 PCS.
Product, CO#2, Material #2, 4 PCS.
In the current stage it is possible no issue/receipt store transactions to be released yet. In such case this distribution is used to reserve materials for Work Order Items. After that when the store transactions begin, the cost of the issue transactions is transferred to the receipt transactions (Stage 2) using the already calculated distribution. 

There are cases when the remaining non-distributed materials on an Output Order are less than what is ordered to be used in the current Output Order by the recipe. In this case for the Output Order is distributed less than the technologically defined quantities and the remaining excess (if, of course, it is requested by following Consumption Orders) will be distributed to the last Output Order of the current work order item (or to an Output Order row marked as "Finished"). Here is an example that illustrates such case.

Example 2:

There is the same Work Order as in Example 1. First, CO#1 is released with 5 PCS of Material #1 and 6 PCS of Material #2. Then an Output Order is released for the 2 PCS of the work order item. By the recipe, 6 PCS of Material #1 and 8 PCS of Material #2 should be distributed. By now no Consumption Orders with no such quantities are released. So the Output Order takes less quantities (the quantities from CO#1):

Work Order Item, CO#1, Material #1, 5 PCS;
Work Order Item, CO#1, Material #2, 6 PCS.
Then CO#2 is released with the rest of the materials quantities - 4 PCS and 6 PCS respectively. When the second Output Order is released for the 1 PCS remaining quantity, more materials per unit will be distributed than in the first Output Order:

Work Order Item, CO#2, Material #1, 4 PCS;
Work Order Item, CO#2, Material #2, 6 PCS.
There are cases when non-distributed materials remain even after the release of the last Output Order on one Work Order. Usually, this appears if there are Consumption Orders which are released after all Output Orders. In this cases in the end an Output Order with 0 quantity is released. Such Output Orders are called Completing Output Orders and all remaining materials are distributed to them. Sometimes the Completing Output Orders may be released and before the last Output Order with non-zero quantities. This is done when there are non-distributed materials but the next Output Orders will not be released any soon. So this Completing Output Orders (sometimes called intermediate) "collect" all the remaining up to this moment material quantities without having to release the next Output Order.
The two examples above describe production processes where each material from the Work Order is assigned to exactly one work order item. There are materials which cannot be assigned to specific work order item (Work Order Item field in Ingredients table is empty). Instead the quantity of the material is distributed to all work order items in the current Work Order. This distribution may be achieved by two methods (different values in Distribute By field):

by Standard Price - the current Standard Price Per Lot of the products from the Work Order rows (the work order items) are used (the standard price is multiplied by the quantities in the rows) and the result is used as a coefficient for materials distribution;
by Measurement - as coefficients the rows quantities from the Work Order rows are used (each quantity is converted to a measurement category, which is specified in the material row; all products have to have defined product dimensions for the specified category).
After the coefficients are defined by one of the described methods, the quantities from the Consumption Order are distributed to a Output Order as follows:

All rows of released non-voided Consumption Orders are filtered. The Consumption orders have to be released before the current Output Order.
The quantities from p.1 are decreased by the material quantities which are distributed to Output Orders released before the current one.
The entire remaining materials quantity (after p.2) is distributed by the coefficients through all rows of the current Output Order (to define the coefficients the quantities from the current Output Order are used).
NOTE: If all work order items have Standard Price Per Lot of 0 (zero), the coefficients would be 0. In that case the cost of all materials from p.2 is distributed equally through the work order items. The reason behind this is to avoid cost lost.

Example 3:

There is a Work Order with 295 PCS of a given material, which is distributed by Standard Price through four work order items of the Work Order - Product #1 (standard price is 17 EUR), Product #2 (standard price is 9 EUR), Product #2 (standard price is 12  EUR) and Product #4 (standard price is 20  EUR). For each work order item 2 PCS are produced.

First, CO #1 is released for 189 PCS of the material. Then, OO #1 is released with the following: 2 PCS of Product #1, 1 PCS of Product #2 and 1 PCS of Product #4. So the coefficients for distribution in the current Output Order are: 2 * 17 : 1 * 9 : 1 * 20 = 34 : 9 : 20. According to this coefficients, the following distribution is achieved:

Product #1, CO#1, Material, 189 * 34 / (34 + 9 + 20) = 102 PCS;
Product #2, CO#1, Material, 189 * 9 / (34 + 9 + 20) = 27 PCS;
Product #3, CO#1, Material, 189 * 20 / (34 + 9 + 20) = 60 PCS.
Then a new CO#2 is released for the rest 106 PCS and the last Output Order is released for the rest of the work order items. It has the following coefficients: 1 * 9 : 9 * 12 : 1 * 20 = 9 : 24 : 20. The distribution is calculated as follows:

Product #2, CO#2, Material, 106 * 9 / (9 + 24 + 20) = 18 PCS;
Product #3, CO#2, Material, 106 * 24 / (9 + 24 + 20) = 48 PCS;
Product #4, CO#2, Material, 106 * 20 / (9 + 24 + 20) = 40 PCS.

## Stage 2: Issue Transactions Cost Distribution 

Once Stage 1 is completed, then the quantity distribution through the materials from the Consumption Orders and the work order items from the Output Orders may be applied to define how the cost of the issue transactions are transferred to the receipt transactions. These distributions are used to form proportions through which the cost of the Consumption order transactions is distributed through the Output Orders. This distribution is also saved in "Distributed Material consumptions" table (in the Output Order document) and then it is used so the cost of the receipt Store Transactions is set correctly. 

When new issue transactions appear from Consumption Orders, an update is executed again of the distributions in all Output Orders from one Work Order, and the quantity distributions are complemented by the cost distributions.

If there is a row from Consumption Order, which contains 15 PCS, and 5 PCS of which are distributed to one Output Order and the rest 10 PCS are distributed to another Output Order. If there are several store transactions to issue all 15 PCS at cost of 371 EUR, then one third of it is distributed to the first Output Order and the rest is distributed to the second one. A detailed example follows.

Example 4

There is Work Order producing 3 PCS of a product. The materials are 9 PCS from Material #1 and 12 PCS of Material #2. The materials are consumed in two stages - Consumption Order CO#1, which has 8 PCS from Material #1 and 8 PCS from Material #2, and CO#2, which has 1 PCS from Material #1 and 4 PCS from Material #2. There is Output Order for 2 PCS of the work order item with the following distribution:

Product, CO#1, Material #1, 6 PCS;
Product, CO#1, Material #2, 8 PCS.
The second Output Order is for 1 PCS from the work order item with the following distribution:

Product, CO#1, Material #1, 2 PCS;
Product, CO#2, Material #1, 1 PCS;
Product, CO#2, Material #2, 4 PCS.
So if the issue cost is 40 EUR for Material #1 and 71 EUR for Material #2 from CO#1 and 7 EUR and 39 EUR for the materials in CO#2, then a distribution is calculated where the quantity comparisons are filled with costs. The first Output Order has the following:

Product, CO#1, Material #1, 6 PCS, 40 * 6 / 8 = 30 EUR;
Product, CO#1, Material #2, 8 PCS, 71 * 8 / 8 = 71 EUR.
And the cost of the produced product from this Output Order is 30 + 71 = 101 EUR. For the second Output Order there is the following:

Product, CO#1, Material #1, 2 PCS, 40 * 2 / 8 = 10 EUR;
Product, CO#2, Material #1, 1 PCS, 7 * 1 / 1 = 7 EUR;
Product, CO#2, Material #2, 4 PCS, 39 * 4 / 4 = 39 EUR.
And the total cost of the produced product is 10 + 7 + 39 = 56  EUR.

## Issue And Receipt Balance

As in the Store Transfers and Sales, in the production there is limitation for the receipt not to exceed the issue. But in production the validation is a bit more complicated because the product in the issue transactions is different then the product in the receipt transaction (the materials are not the same as the produced product). So the total quantities of issue and receipt transactions cannot be compared directly.

The limitation is applied on all store transactions that are caused by a Work Order and for each Transaction Timestamp the following is executed:

all issues are summed up (the materials) with Transaction Timestamp less or equal to the current and by their receipts from the Work Order is defined what is the largest quantity that is available for production from these materials;
all receipts (the produced products) are summed up that has Transaction Timestamp less or equal to the current;
a validation is performed to check if the maximum quantity of the product from p.1 is bigger or equal to the receipt total from p2.
For more information about this validation see Receipt And Issue Balance Validation In Store Transfers.
